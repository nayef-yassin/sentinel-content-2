{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2020-08-01",
      "name": "[concat(parameters('workspace'), '/FireEyeRedTeamComms')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "eTag": "*",
        "displayName": "FireEye stolen red teaming tools communications",
        "category": "Hunting Queries",
        "query": "\nlet domainCountThreshold = 100; //Maxiumum number of times a domain ahs been visited\n//Backdoor.HTTP.BEACON.[Yelp GET]\nlet FEQuery1 = CommonSecurityLog\n| where RequestMethod == \"GET\"\n| where RequestURL contains \"&parent_request_id=\"\n| where RequestURL matches regex @\"&parent_request_id=(?:[A-Za-z0-9_\\/\\+\\-\\%]{128,1000})={0,2}[^\\r\\n]{0,256}\"\n| extend Quality = \"high\"\n| extend RuleName = \"Backdoor.HTTP.BEACON.[Yelp GET]\"\n| project TimeGenerated, Quality, RuleName, DeviceVendor, DeviceProduct, TenantId, SourceIP, DestinationIP, DestinationHostName, RequestMethod, RequestURL;\n//Backdoor.HTTP.BEACON.[CSBundle CDN GET]\nlet FEQuery2 = CommonSecurityLog\n| where RequestMethod == \"GET\"\n| where FileType =~ \"GZIP\"\n| where RequestURL matches regex @\"(?:\\/v1\\/queue|\\/v1\\/profile|\\/v1\\/docs\\/wsdl|\\/v1\\/pull)\"\n| extend Quality = \"low\"\n| extend RuleName = \"Backdoor.HTTP.BEACON.[CSBundle CDN GET]\"\n| project TimeGenerated, Quality, RuleName, DeviceVendor, DeviceProduct, TenantId, SourceIP, DestinationIP, DestinationHostName, RequestMethod, RequestURL;\n//Backdoor.HTTP.BEACON.[CSBundle USAToday GET]\nlet FEQuery3 = CommonSecurityLog\n| where RequestMethod == \"GET\"\n| where isempty(RequestContext)\n| where RequestURL matches regex @\"(?:\\/USAT-GUP\\/user\\/|\\/entertainment\\/|\\/entertainment\\/navdd-q1a2z3Z6TET4gv2PNfXpaJAniOzOajK7M\\.min\\.json|\\/global-q1a2z3C4M2nNlQYzWhCC0oMSEFjQbW1KA\\.min\\.json|\\/life\\/|\\/news\\/weather\\/|\\/opinion\\/|\\/sports\\/|\\/sports\\/navdd-q1a2z3JHa8KzCRLOQAnDoVywVWF7UwxJs\\.min\\.json|\\/tangstatic\\/js\\/main-q1a2z3b37df2b1\\.min\\.js|\\/tangstatic\\/js\\/pbjsandwich-q1a2z300ab4198\\.min\\.js|\\/tangstatic\\/js\\/pg-q1a2z3bbc110a4\\.min\\.js|\\/tangsvc\\/pg\\/3221104001\\/|\\/ta`ngsvc\\/pg\\/5059005002\\/|\\/tangsvc\\/pg\\/5066496002\\/|\\/tech\\/|\\/travel\\/)\"\n| where DestinationHostName !endswith \"usatoday.com\"\n| extend Quality = \"medium\"\n| extend RuleName = \"Backdoor.HTTP.BEACON.[CSBundle USAToday GET]\"\n| project TimeGenerated, Quality, RuleName, DeviceVendor, DeviceProduct, TenantId, SourceIP, DestinationIP, DestinationHostName, RequestMethod, RequestURL;\n//Backdoor.HTTP.BEACON.[CSBundle Original POST]\nlet FEQuery4 = CommonSecurityLog\n| where RequestMethod == \"POST\"\n| where isempty(RequestContext)\n| where RequestURL matches regex @\"(?:\\/v4\\/links\\/check-activity\\/check|\\/v1\\/stats|\\/gql|\\/api2\\/json\\/check\\/ticket|\\/1.5\\/95648064\\/storage\\/history|\\/1.5\\/95648064\\/storage\\/tabs|\\/u\\/0\\/_\\/og\\/botguard\\/get|\\/ev\\/prd001001|\\/ev\\/ext001001|\\/gp\\/aw\\/ybh\\/handlers|\\/v3\\/links\\/ping-beat\\/check)\"\n| extend Quality = \"low\"\n| extend RuleName = \"Backdoor.HTTP.BEACON.[CSBundle Original POST]\"\n| project TimeGenerated, Quality, RuleName, DeviceVendor, DeviceProduct, TenantId, SourceIP, DestinationIP, DestinationHostName, RequestMethod, RequestURL;\n//Backdoor.HTTP.BEACON.[CSBundle MSOffice POST\nlet FEQuery5 = CommonSecurityLog\n| where RequestMethod == \"POST\"\n| where isempty(RequestContext)\n| where RequestURL contains \"/v1/push\"\n| extend Quality = \"low\"\n| extend RuleName = \"Backdoor.HTTP.BEACON.[CSBundle MSOffice POST]\"\n| project TimeGenerated, Quality, RuleName, DeviceVendor, DeviceProduct, TenantId, SourceIP, DestinationIP, DestinationHostName, RequestMethod, RequestURL;\n//Backdoor.HTTP.BEACON.[CSBundle NYTIMES POST]\nlet FEQuery6 = CommonSecurityLog\n| where RequestMethod == \"POST\"\n| where isempty(RequestContext)\n| where RequestURL matches regex @\"(?:\\/track|\\/api\\/v1\\/survey\\/embed|\\/svc\\/weather\\/v2)\"\n| extend Quality = \"low\"\n| extend RuleName = \"Backdoor.HTTP.BEACON.[CSBundle NYTIMES POST]\"\n| project TimeGenerated, Quality, RuleName, DeviceVendor, DeviceProduct, TenantId, SourceIP, DestinationIP, DestinationHostName, RequestMethod, RequestURL;\n//Backdoor.HTTP.BEACON.[CSBundle MSOffice GET]\nlet FEQuery7 = CommonSecurityLog\n| where RequestMethod == \"GET\"\n| where isempty(RequestContext)\n| where RequestURL matches regex @\"(?:\\/updates|\\/license\\/eula|\\/docs\\/office|\\/software-activation)\"\n| extend Quality = \"low\"\n| extend RuleName = \"Backdoor.HTTP.BEACON.[CSBundle MSOffice GET]\"\n| project TimeGenerated, Quality, RuleName, DeviceVendor, DeviceProduct, TenantId, SourceIP, DestinationIP, DestinationHostName, RequestMethod, RequestURL;\n//Backdoor.HTTP.BEACON.[CSBundle MSOffice POST]\nlet FEQuery8 = CommonSecurityLog\n| where RequestMethod == \"POST\"\n| where isempty(RequestContext)\n| where RequestURL contains \"/notification\"\n| extend Quality = \"low\"\n| extend RuleName = \"Backdoor.HTTP.BEACON.[CSBundle MSOffice POST]\"\n| project TimeGenerated, Quality, RuleName, DeviceVendor, DeviceProduct, TenantId, SourceIP, DestinationIP, DestinationHostName, RequestMethod, RequestURL;\n//Backdoor.HTTP.BEACON.[CSBundle Original GET]\nlet FEQuery9 = CommonSecurityLog\n| where RequestMethod == \"GET\"\n| where isempty(RequestContext)\n| where RequestURL matches regex @\"(?:\\/api2\\/json\\/access\\/ticket|\\/api2\\/json\\/cluster\\/resources|\\/api2\\/json\\/cluster\\/tasks|\\/en-us\\/p\\/onerf\\/MeSilentPassport|\\/en-us\\/p\\/book-2\\/8MCPZJJCC98C|\\/en-us\\/store\\/api\\/checkproductinwishlist|\\/gp\\/cerberus\\/gv|\\/gp\\/aj\\/private\\/reviewsGallery\\/get-application-resources|\\/gp\\/aj\\/private\\/reviewsGallery\\/get-image-gallery-assets|\\/v1\\/buckets\\/default\\/ext-5dkJ19tFufpMZjVJbsWCiqDcclDw\\/records|\\/v3\\/links\\/ping-centre|\\/v4\\/links\\/activity-stream|\\/wp-content\\/themes\\/am43-6\\/dist\\/records|\\/wp-content\\/themes\\/am43-6\\/dist\\/records|\\/wp-includes\\/js\\/script\\/indigo-migrate)\"\n| extend Quality = \"medium\"\n| extend RuleName = \"Backdoor.HTTP.BEACON.[CSBundle Original GET]\"\n| project TimeGenerated, Quality, RuleName, DeviceVendor, DeviceProduct, TenantId, SourceIP, DestinationIP, DestinationHostName, RequestMethod, RequestURL;\nlet Results = union FEQuery1, FEQuery3, FEQuery4, FEQuery5, FEQuery6, FEQuery7, FEQuery8, FEQuery9;\n//Check to see if the destination host name is low hitting in data, defeats a lot of legit API traffic\nResults\n| join (\n    CommonSecurityLog\n    | where DestinationHostName != \"\"\n  | summarize DomainCount=count() by DestinationHostName)\non $left.DestinationHostName == $right.DestinationHostName\n| project TimeGenerated, Quality, DeviceVendor, DeviceProduct, TenantId, SourceIP, DestinationIP, DestinationHostName, RequestMethod, RequestURL, DomainCount\n| where DomainCount <= domainCountThreshold\n",
        "version": 1,
        "tags": [
          {
            "name": "description",
            "value": "This composite hunting query will highlight any HTTP traffic in CommonSecurityLog web proxies (such as ZScaler) that match known patterns used by red teaming tools potentially stolen from FireEye. Most FireEye red teaming tools are designed"
          },
          {
            "name": "tactics",
            "value": "CommandAndControl"
          },
          {
            "name": "relevantTechniques",
            "value": "T1071.001"
          }
        ]
      }
    }
  ]
}
